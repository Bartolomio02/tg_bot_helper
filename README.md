# Telegram Bot Helper

Telegram бот, який надає допомогу у випадках сексуального насильства.

## Налаштування та Запуск

Перед запуском:

1. Створіть файл `.env` в кореневій директорії
2. Додайте необхідні змінні середовища до файлу `.env`:
   ```
   # Обов'язкові змінні
   TELEGRAM_BOT_TOKEN=ваш_токен_бота
   OPERATOR_IDS=id1,id2,id3    # ID операторів через кому

   # Опціональні змінні для налаштування обмеження повідомлень
   RATE_LIMIT_MESSAGES=20    # Максимальна кількість повідомлень (за замовчуванням 20)
   RATE_LIMIT_PERIOD=60     # Період скидання обмежень у секундах (за замовчуванням 60)
   ```
3. Встановіть залежності:
   ```
   pip install -r requirements.txt
   ```
4. Запустіть бота:
   ```
   python main.py
   ```

## Команди Бота

### Загальні команди
- `/start` - Почати спілкування з ботом
- `/help` - Отримати довідку про можливості бота
- `/cancel` - Скасувати поточну дію (наприклад, заповнення форми)

### Команди операторів
- `/block ID` - Заблокувати користувача
- `/unblock ID` - Розблокувати користувача
- `/blocked_list` - Показати список заблокованих користувачів

## Можливості

- Перевірка робочих годин (9:00-20:00)
- Автоматизований збір форм
- Система тайм-аутів при заповненні анкети:
  - Автоматична перевірка активності користувача
  - Можливість продовжити заповнення після паузи
  - Збереження прогресу заповнення
- Управління доступом користувачів:
  - Можливість блокування проблемних користувачів
  - Ведення списку заблокованих користувачів
  - Можливість розблокування користувачів
  - Автоматичне збереження списку блокувань
- Підтримка декількох операторів:
  - Налаштування через список ID у змінних середовища
  - Одночасне сповіщення всіх операторів
  - Можливість відповіді від будь-якого оператора
  - Синхронізація повідомлень між операторами
- Захист від спаму через Rate Limiting:
  - Налаштування обмежень через змінні середовища
  - За замовчуванням: 20 повідомлень за 60 секунд
  - Автоматичне скидання обмежень після закінчення періоду
  - Виключення операторів з обмежень
  - Інформативні повідомлення при перевищенні ліміту
- Багатокористувацький режим:
  - Одночасна робота з необмеженою кількістю користувачів
  - Окремий стан та контекст для кожного користувача
  - Незалежна обробка форм для кожного користувача
  - Чітка ідентифікація користувачів у всіх повідомленнях
- Комплексна система спілкування з операторами:
  - Всі повідомлення користувачів пересилаються всім операторам з контекстом
  - Чітка ідентифікація користувача в кожному повідомленні (ID, ім'я, username)
  - Підсумки повідомлень та сповіщення про заповнення форм
  - Зручна система відповідей через відповіді на повідомлення
  - Автоматичний перехід в ручний режим при відповіді оператора
- Спеціальні обробники для запитів медіа/організацій
- Підтримка допомоги іншим
- Обробка термінової допомоги в неробочий час
- Відправка медіафайлів та документів операторами
- Форматування повідомлень:
  - HTML-форматування для кращої читабельності
  - Емодзі для візуального розділення інформації
  - Виділення важливої інформації жирним шрифтом
- Обробка помилок:
  - Валідація віку користувача
  - Перевірка на нетекстові повідомлення
  - Інформативні повідомлення про помилки
  - Можливість скасування поточної дії

## Система Тайм-аутів

### Основні функції

- **Автоматична перевірка активності**: Якщо користувач не відповідає протягом 3 хвилин під час заповнення анкети, бот запитує про бажання продовжити
- **Кнопки відповіді**: 
  - "Так" або інший текст - продовження заповнення з місця зупинки
  - "Ні" - скасування заповнення анкети
- **Збереження прогресу**:
  - При продовженні заповнення всі попередні відповіді зберігаються
  - Користувач продовжує з останнього незаповненого поля
- **Автоматичне очищення**:
  - При скасуванні анкети всі дані очищуються
  - При завершенні заповнення таймер автоматично вимикається
- **Незалежність для кожного користувача**:
  - Окремий таймер для кожного користувача
  - Незалежне відстеження стану заповнення
  - Індивідуальне збереження прогресу

### Процес роботи

1. **Початок заповнення**:
   - Запускається таймер на 3 хвилини
   - Користувач отримує перше питання анкети

2. **Під час заповнення**:
   - При кожній відповіді таймер оновлюється
   - Якщо відповідь не надходить 3 хвилини, з'являється запит про продовження

3. **Запит про продовження**:
   - Текст: "❓ Продовжимо?"
   - Кнопки: "Так" / "Ні"

4. **Варіанти розвитку**:
   - **При виборі "Так" або інший текс**:
     - Відновлення заповнення з місця зупинки
     - Запуск нового таймера
   - **При виборі "Ні"**:
     - Скасування заповнення
     - Очищення даних форми
     - Можливість почати спочатку через /start

## Інструкції для Операторів

1. **Перегляд Повідомлень**: 
   - Кожне переслане повідомлення містить контекст та ID користувача
   - Відповіді форми чітко позначені питанням, на яке вони відповідають
   - Повні підсумки форм надаються після їх заповнення
   - Всі повідомлення мають зручне форматування та емодзі для швидкої орієнтації

2. **Відповіді Користувачам**:
   - Відповідайте на будь-яке повідомлення користувача для початку ручного режиму
   - Бот автоматично перешле вашу відповідь правильному користувачу
   - Ручний режим продовжується, поки ви не припините відповідати

3. **Управління Доступом**:
   - Використовуйте `/block ID` для блокування проблемних користувачів
   - Використовуйте `/unblock ID` для розблокування користувачів
   - Переглядайте список заблокованих через `/blocked_list`
   - ID користувача можна знайти в будь-якому пересланому повідомленні

4. **Паралельні Розмови**:
   - Підтримується одночасна робота з необмеженою кількістю користувачів
   - Кожен користувач має власний незалежний стан та контекст
   - Всі повідомлення містять чітку ідентифікацію користувача
   - Система автоматично направляє ваші відповіді потрібному користувачу
   - Можна легко перемикатися між різними розмовами

## Технічні Особливості

- Використання FSM (Finite State Machine) для управління станами користувачів
- Окремий контекст MemoryStorage для кожного користувача
- Асинхронна обробка повідомлень
- Надійна система ідентифікації користувачів
- Автоматичне управління режимами спілкування
- HTML форматування повідомлень:
  - Використання тегів <b> для важливої інформації
  - Використання тегів <i> для додаткового тексту
  - Використання тегів <code> для ID користувачів
  - Підтримка емодзі для візуального розділення інформації
- Система обробки помилок:
  - Валідація введених даних
  - Перевірка формату повідомлень
  - Захист від некоректного вводу
  - Інформативні повідомлення про помилки
- Безпека:
  - Конфігурація через змінні середовища
  - Перевірка прав доступу операторів
  - Валідація даних користувача
  - Налаштування обмежень частоти повідомлень
  - Система блокування проблемних користувачів
  - Ефективне кешування даних користувачів

## Форматування Повідомлень

### Емодзі та їх значення

- 📋 Форми та ID користувачів
- 👤 Ім'я користувача
- 📱 Username
- 📝 Контекст та опис
- 🔍 Деталі події
- 🆘 Тип допомоги
- 🆕 Новий чат
- ❌ Повідомлення про помилки та блокування
- ⚠️ Попередження про перевищення ліміту
- ✅ Підтвердження дій
- 📅 Вік користувача
- 📍 Місцезнаходження
- ❓ Запит про продовження заповнення анкети або інше питання

### HTML Теги

- `<b>...</b>` - Жирний текст для заголовків та важливої інформації
- `<i>...</i>` - Курсив для контексту та описів
- `<code>...</code>` - Моноширинний шрифт для ID користувачів

### Приклади Форматування

1. Нове повідомлення:
   ```
   📋 Повідомлення від користувача:
   👤 Ім'я: Іван
   📱 Username: @user
   📝 Контекст: Звернення за допомогою
   ```

2. Заповнена форма:
   ```
   📋 Форма заповнена:
   👤 Ім'я: Іван
   📅 Вік: 25
   📍 Місцезнаходження: Київ
   🔍 Деталі події: ...
   🆘 Тип допомоги: ...
   ```

## Обробка Помилок

### Валідація Даних

- **Вік**: Перевірка на числове значення в діапазоні 1-120 років
- **Текстові поля**: Перевірка на наявність тексту
- **Формат повідомлень**: Обробка тільки текстових повідомлень
- **Частота повідомлень**: Перевірка на перевищення ліміту
- **Доступ**: Перевірка на блокування користувача

### Повідомлення про Помилки

- Чіткі інструкції щодо виправлення помилок
- Можливість скасувати поточну дію
- Підказки щодо правильного формату даних
- Інформативні повідомлення при перевищенні ліміту повідомлень
- Сповіщення про блокування доступу

### Безпека

- Перевірка конфігурації при запуску
- Валідація ID операторів
- Захист від некоректних даних
- Налаштування системи обмеження частоти повідомлень через змінні середовища
- Система блокування небажаних користувачів
- Ефективне кешування даних користувачів
